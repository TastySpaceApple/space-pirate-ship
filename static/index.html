<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Ahoy!</title>
	<link type="text/css" rel="stylesheet" href="css/stylesheet.css"/>
</head>
<body>
  <ul id="listTorrents">
  </ul>
  <div id="bottomBar">
	<button id="btnPlay">Play</button>
	<button id="btnStop">Stop</button>
  </div>
  <script type="text/javascript">
	  var collection = [];
	  var selectedItem;
	  
	  var requests = {
		  get : function (url, callback){
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.onreadystatechange = function() { 
					if (xmlHttp.readyState == 4 && xmlHttp.status == 200)
						callback(xmlHttp.responseText);
				}
				xmlHttp.open("GET", url, true); // true for asynchronous 
				xmlHttp.send(null);
			},
			post : function(url, data){
				var xmlHttp = new XMLHttpRequest();
				xmlHttp.open('POST', '/play', false);
				xmlHttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
				xmlHttp.send(data);
			}
	  }
	  
	  function Torrent(data){
		var dom = document.createElement('li');
		
		var progressbar = document.createElement('div');
		progressbar.className = "progressbar";
		
		var textel = document.createElement('h3');
		textel.innerHTML = data.title;
		
		dom.appendChild(progressbar);
		dom.appendChild(textel);
		
		var _selected = false;
		
		function update(newData){
			data = newData;
			textel.innerHTML = data.title + ' : ' + (data.progress*100).toFixed(2) + '%';
			progressbar.style.width = data.progress*100+'%';
			if(data.ready)
				dom.className = 'ready';
		}
		
		function init(){
			update(data);
		}
		
		init();
		
		function selected(val){
			if(typeof(val) == 'undefined')
				return _selected;
			else{
				_selected = val;
				if(_selected)
					dom.setAttribute('data-selected', 'true');
				else{
					dom.setAttribute('data-selected', 'false');
					dom.setAttribute('data-playing', 'false');
				}
			}
		}
		
		function play(){
			requests.post('/play', 'title='+data.title);
			dom.setAttribute('data-playing', 'true');
		}
		
		return{
			selected : selected,
			play:play,
			dom:dom,
			update: update,
			title: function(){ return data.title; }
		}
	  }
	  
	  function has(item){
	  	for(var i=0; i<collection.length; i++){
			if(collection[i].title() == item.title)
				return collection[i];
		}
		return null;
	  }
	  
	  function fetch(){
	  	requests.get('/torrents', function(responseText){
			var c = JSON.parse(responseText);
			for(var i=0; i < c.length; i++){
				var torrent = has(c[i]);
				if(torrent)
					torrent.update(c[i]);
				else{
					torrent = new Torrent(c[i]);
					collection.push(torrent);
					document.querySelector('#listTorrents').appendChild(torrent.dom);
				}
			}
			setTimeout(fetch, 1000);
		})
	  }
	  
	  window.onload = function(){
		fetch();
		document.querySelector('#listTorrents').addEventListener('click', function(e){
			if(e.target == this) return; //must have pressed between the gaps
			var tdom = e.target.parentNode;
			var torrent;
			for(var i=0; i<collection.length; i++){
				if(collection[i].dom == tdom)
					torrent = collection[i];
			}
			torrent.selected(true);
			if(selectedItem)
				selectedItem.selected(false);
			selectedItem = torrent;
		});
		
		document.querySelector('#btnPlay').addEventListener('click', function(){
			if(selectedItem)
				selectedItem.play();
		})
		
		document.querySelector('#btnStop').addEventListener('click', function(){
			requests.post('/stop');
		})
	  }
  </script>
</body>
</html>

